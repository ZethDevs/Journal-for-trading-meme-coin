<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lutfi Farid | Modern Trading Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header card-hover">
            <div>
                <h1>
                    <i class="fas fa-chart-network"></i>
                    Lutfi Farid Dashboard
                </h1>
                <p class="subtitle" style="color: var(--gray); margin-top: 8px;">
                    Modern trading analytics for meme coin markets
                </p>
            </div>
            <div class="header-info">
                <div class="header-stat">
                    <div class="label">Active Positions</div>
                    <div class="value">{{ data|length }}</div>
                </div>
                <div class="header-stat">
                    <div class="label">Win Rate</div>
                    <div class="value">
                        {% if data|length > 0 %}
                            {{ "%.0f"|format((profitable_trades / data|length) * 100) }}%
                        {% else %}
                            0%
                        {% endif %}
                    </div>
                </div>
                <button class="btn-saldo" onclick="resetAllData()" style="background: var(--danger-pastel); color: var(--danger);">
                    <i class="fas fa-redo"></i> Reset All
                </button>
            </div>
        </div>

        <!-- Saldo Section -->
        <div class="saldo-section">
            <!-- Saldo Card -->
            <div class="saldo-card card-hover floating">
                <div class="saldo-header">
                    <h3>
                        <i class="fas fa-wallet"></i>
                        Portfolio Balance
                    </h3>
                    <div class="saldo-actions">
                        <button class="btn-saldo btn-edit-saldo" onclick="openSaldoModal()">
                            <i class="fas fa-sliders-h"></i> Adjust Balance
                        </button>
                        <button class="btn-saldo btn-refresh" onclick="refreshSaldo()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="saldo-amount">
                    Rp {{ "{:,.0f}".format(total_saldo) }}
                </div>
                <div class="saldo-change">
                    {% if saldo_change > 0 %}
                    <span class="change-positive">
                        <i class="fas fa-arrow-trend-up"></i>
                        +Rp {{ "{:,.0f}".format(saldo_change) }} 
                        ({{ "{:,.2f}".format(saldo_change_percentage) }}%)
                    </span>
                    {% elif saldo_change < 0 %}
                    <span class="change-negative">
                        <i class="fas fa-arrow-trend-down"></i>
                        -Rp {{ "{:,.0f}".format(-saldo_change) }} 
                        ({{ "{:,.2f}".format(-saldo_change_percentage) }}%)
                    </span>
                    {% else %}
                    <span class="change-positive">
                        <i class="fas fa-minus"></i> No Change
                    </span>
                    {% endif %}
                    <span class="change-period">24h change</span>
                </div>
            </div>

            <!-- Chart Container -->
            <div class="chart-container card-hover">
                <div class="chart-header">
                    <h3>
                        <i class="fas fa-chart-line"></i>
                        Performance Chart
                    </h3>
                    <div class="chart-controls">
                        <select id="chartRange" onchange="updateChart()">
                            <option value="7">7 Days</option>
                            <option value="14">14 Days</option>
                            <option value="30" selected>30 Days</option>
                        </select>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="saldoChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-cards">
            <div class="stat-card card-hover">
                <h3><i class="fas fa-cube"></i> Total Capital</h3>
                <div class="value">Rp {{ "{:,.0f}".format(total_modal) }}</div>
                <div class="subtitle">Deployed Capital</div>
            </div>
            
            <div class="stat-card card-hover">
                <h3><i class="fas fa-bolt"></i> P&L Total</h3>
                <div class="value {{ 'profit' if total_profit > 0 else 'loss' }}">
                    {% if total_profit > 0 %}+{% endif %}Rp {{ "{:,.0f}".format(total_profit) }}
                </div>
                <div class="subtitle">Realized Profit & Loss</div>
            </div>
            
            <div class="stat-card card-hover">
                <h3><i class="fas fa-percentage"></i> ROI</h3>
                <div class="value {{ 'profit' if total_profit_percentage > 0 else 'loss' }}">
                    {% if total_profit_percentage > 0 %}+{% endif %}{{ "{:,.2f}".format(total_profit_percentage) }}%
                </div>
                <div class="subtitle">Return on Investment</div>
            </div>
            
            <div class="stat-card card-hover">
                <h3><i class="fas fa-layer-group"></i> Positions</h3>
                <div class="value">{{ data|length }}</div>
                <div class="subtitle">Active Positions</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls card-hover">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search assets...">
            </div>
            <button class="btn btn-primary" onclick="openTradeModal()">
                <i class="fas fa-plus-circle"></i> Add First Position
            </button>
        </div>

        <!-- Table -->
        <div class="table-container card-hover">
            {% if data|length > 0 %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Asset</th>
                        <th>Capital</th>
                        <th>Position</th>
                        <th>P&L</th>
                        <th>ROI</th>
                        <th>Entry Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tradeTable">
                    {% for item in data %}
                    <tr id="trade-row-{{ item.id }}">
                        <td>#{{ item.id }}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span class="status-indicator {{ item.status }}"></span>
                                <span style="font-weight: 600;">{{ item.nama_koin }}</span>
                            </div>
                        </td>
                        <td>
                            <span style="font-weight: 600;">Rp {{ "{:,.0f}".format(item.modal) }}</span>
                        </td>
                        <td>
                            <span class="status-badge status-{{ item.status }}">
                                <i class="fas fa-{{ 'arrow-up' if item.status == 'profit' else 'arrow-down' }}"></i>
                                {{ item.status|upper }}
                            </span>
                        </td>
                        <td class="{{ 'profit' if item.jumlah_profit > 0 else 'loss' }}">
                            <span style="display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-{{ 'arrow-up' if item.jumlah_profit > 0 else 'arrow-down' }}"></i>
                                {% if item.jumlah_profit > 0 %}+{% endif %}Rp {{ "{:,.0f}".format(item.jumlah_profit) }}
                            </span>
                        </td>
                        <td class="{{ 'profit' if item.persen_profit > 0 else 'loss' }}">
                            <span style="display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-{{ 'arrow-up' if item.persen_profit > 0 else 'arrow-down' }}"></i>
                                {% if item.persen_profit > 0 %}+{% endif %}{{ "{:,.2f}".format(item.persen_profit) }}%
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-info">
                                <i class="far fa-calendar"></i>
                                {{ item.get('tanggal', 'N/A') }}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-edit tooltip" onclick="editTrade({{ item.id }})">
                                    <i class="fas fa-edit"></i> Edit
                                    <span class="tooltip-text">Edit this position</span>
                                </button>
                                <button class="btn-delete tooltip" onclick="deleteTrade({{ item.id }}, this)">
                                    <i class="fas fa-trash"></i> Delete
                                    <span class="tooltip-text">Delete this position</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <!-- Empty State -->
            <div style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 64px; color: var(--gray); margin-bottom: 20px;">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h3 style="color: var(--dark-gray); margin-bottom: 12px;">
                    No Trading Positions Yet
                </h3>
                <p style="color: var(--gray); margin-bottom: 30px; max-width: 400px; margin-left: auto; margin-right: auto;">
                    Start tracking your meme coin trades by adding your first position. Click the "Add First Position" button above to begin.
                </p>
                <button class="btn btn-primary" onclick="openTradeModal()" style="padding: 12px 24px;">
                    <i class="fas fa-plus-circle"></i> Add Your First Position
                </button>
                <div style="margin-top: 30px; padding: 20px; background: var(--light-gray); border-radius: 12px; max-width: 500px; margin-left: auto; margin-right: auto;">
                    <h4 style="color: var(--dark-gray); margin-bottom: 10px;">
                        <i class="fas fa-lightbulb"></i> Getting Started Tips
                    </h4>
                    <ul style="text-align: left; color: var(--gray); padding-left: 20px;">
                        <li style="margin-bottom: 8px;">Set your starting balance using the "Adjust Balance" button</li>
                        <li style="margin-bottom: 8px;">Add each meme coin trade as a separate position</li>
                        <li style="margin-bottom: 8px;">Track both profits and losses to monitor your performance</li>
                        <li>Use the chart to visualize your portfolio growth over time</li>
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Modal for Add/Edit Trade -->
        <div id="tradeModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">
                        <i class="fas fa-plus-circle"></i>
                        <span id="modalTitleText">Add Trading Position</span>
                    </h2>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <form id="tradeForm">
                    <input type="hidden" id="tradeId">
                    
                    <div class="form-group">
                        <label for="nama_koin">
                            <i class="fas fa-coins"></i> Asset Symbol
                        </label>
                        <input type="text" id="nama_koin" required 
                               placeholder="e.g., DOGE, SHIB, PEPE"
                               style="text-transform: uppercase;">
                    </div>
                    
                    <div class="form-group">
                        <label for="modal">
                            <i class="fas fa-money-bill-wave"></i> Capital Amount (Rp)
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="modal" required 
                                   placeholder="1,000,000"
                                   class="number-input"
                                   oninput="formatNumberInput(this)">
                            <input type="hidden" id="modal_raw">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="status">
                            <i class="fas fa-chart-line"></i> Position Status
                        </label>
                        <select id="status" required>
                            <option value="">Select Position Type</option>
                            <option value="profit">üü¢ PROFIT (Successful Trade)</option>
                            <option value="loss">üî¥ LOSS (Unsuccessful Trade)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="jumlah_profit">
                            <i class="fas fa-bolt"></i> Profit/Loss Amount (Rp)
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="jumlah_profit" required 
                                   placeholder="150,000 (negative for loss)"
                                   class="number-input"
                                   oninput="formatNumberInput(this)">
                            <input type="hidden" id="jumlah_profit_raw">
                        </div>
                        <small>Enter negative value for loss positions (e.g., -50,000)</small>
                    </div>
                    
                    <div class="form-group" style="display: flex; gap: 10px;">
                        <button type="submit" class="btn-submit" style="flex: 1;">
                            <i class="fas fa-save"></i> Save Position
                        </button>
                        <button type="button" onclick="closeModal()" 
                                style="flex: 1; background: var(--gray);" 
                                class="btn-submit">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal for Edit Saldo -->
        <div id="saldoModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>
                        <i class="fas fa-sliders-h"></i>
                        Set Starting Balance
                    </h2>
                    <span class="close" onclick="closeSaldoModal()">&times;</span>
                </div>
                <form id="saldoForm">
                    <div class="form-group">
                        <label for="saldo_awal">
                            <i class="fas fa-wallet"></i> Starting Balance (Rp)
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="saldo_awal" required 
                                   placeholder="0"
                                   class="number-input"
                                   oninput="formatNumberInput(this)"
                                   value="{{ "{:,.0f}".format(total_saldo - total_profit) }}">
                            <input type="hidden" id="saldo_awal_raw">
                        </div>
                        <small>Set your initial balance before any trades</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="keterangan">
                            <i class="fas fa-sticky-note"></i> Note (Optional)
                        </label>
                        <input type="text" id="keterangan" 
                               placeholder="e.g., Initial deposit, Starting capital">
                    </div>
                    
                    <div class="form-group" style="display: flex; gap: 10px;">
                        <button type="submit" class="btn-submit" style="flex: 1;">
                            <i class="fas fa-check-circle"></i> Set Balance
                        </button>
                        <button type="button" onclick="closeSaldoModal()" 
                                style="flex: 1; background: var(--gray);" 
                                class="btn-submit">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <div style="text-align: center; padding: 32px; color: var(--gray);">
            <div style="display: flex; justify-content: center; gap: 32px; margin-bottom: 20px; flex-wrap: wrap;">
                {% if data|length > 0 %}
                <div class="badge badge-success" style="display: inline-flex; align-items: center; gap: 8px;">
                    <i class="fas fa-check-circle"></i>
                    <span>Profitable Positions: {{ profitable_trades }}</span>
                </div>
                <div class="badge badge-warning" style="display: inline-flex; align-items: center; gap: 8px;">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Loss Positions: {{ data|length - profitable_trades }}</span>
                </div>
                <div class="badge badge-info" style="display: inline-flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chart-pie"></i>
                    <span>Total Trades: {{ data|length }}</span>
                </div>
                {% else %}
                <div class="badge badge-info" style="display: inline-flex; align-items: center; gap: 8px;">
                    <i class="fas fa-info-circle"></i>
                    <span>Ready to track your first trade!</span>
                </div>
                {% endif %}
            </div>
            <p style="font-size: 14px; margin-bottom: 8px;">
                Lutfi Farid Dashboard v2.0 ‚Ä¢ Start Fresh, Trade Smart
            </p>
            <p style="font-size: 12px; opacity: 0.8;">
                {% if data|length == 0 %}
                No positions yet ‚Ä¢ Add your first trade to begin tracking
                {% else %}
                Tracking {{ data|length }} positions ‚Ä¢ Last updated: {{ now }}
                {% endif %}
            </p>
        </div>
    </div>

    <script>
        // Chart initialization with light theme
        let saldoChart;
        
        function initChart() {
            const ctx = document.getElementById('saldoChart').getContext('2d');
            
            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 250);
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.2)');
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0.05)');
            
            saldoChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: {{ chart_labels|tojson }},
                    datasets: [{
                        label: 'Portfolio Balance',
                        data: {{ chart_data|tojson }},
                        borderColor: '#6366f1',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            padding: 12,
                            cornerRadius: 8,
                            boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
                            callbacks: {
                                label: function(context) {
                                    return `Balance: Rp ${context.parsed.y.toLocaleString('id-ID')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(226, 232, 240, 0.8)',
                                borderColor: 'rgba(226, 232, 240, 0.8)'
                            },
                            ticks: {
                                color: '#64748b',
                                callback: function(value) {
                                    return 'Rp ' + value.toLocaleString('id-ID');
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(226, 232, 240, 0.8)',
                                borderColor: 'rgba(226, 232, 240, 0.8)'
                            },
                            ticks: {
                                color: '#64748b'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Format number input with thousand separators
        function formatNumberInput(input) {
            // Remove non-numeric characters except minus sign
            let value = input.value.replace(/[^\d-]/g, '');
            
            // Handle negative numbers
            const isNegative = value.startsWith('-');
            if (isNegative) {
                value = value.substring(1);
            }
            
            // Remove leading zeros
            value = value.replace(/^0+/, '');
            
            // Format with thousand separators
            if (value) {
                const formatted = new Intl.NumberFormat('id-ID').format(parseInt(value || '0'));
                input.value = (isNegative ? '-' : '') + formatted;
            } else {
                input.value = '';
            }
            
            // Store raw value in hidden field
            const rawValue = (isNegative ? '-' : '') + (value || '0');
            const hiddenInput = input.parentElement.querySelector('input[type="hidden"]');
            if (hiddenInput) {
                hiddenInput.value = rawValue;
            }
            
            return rawValue;
        }

        // Get raw number value from formatted input
        function getNumberValue(inputId) {
            const input = document.getElementById(inputId);
            const hiddenInput = input.parentElement.querySelector('input[type="hidden"]');
            
            if (hiddenInput && hiddenInput.value) {
                const rawValue = hiddenInput.value.replace(/\./g, '');
                return parseFloat(rawValue) || 0;
            }
            
            // Fallback: parse formatted value
            const formattedValue = input.value.replace(/[^\d-]/g, '');
            return parseFloat(formattedValue) || 0;
        }

        // Reset all data to empty
        async function resetAllData() {
            if (!confirm('Are you sure you want to reset ALL data?\nThis will delete all current positions and reset balance to 0.\nThis action cannot be undone!')) {
                return;
            }
            
            try {
                const response = await fetch('/api/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('All data has been reset to empty', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    throw new Error(result.message || 'Failed to reset data');
                }
            } catch (error) {
                console.error('Error resetting data:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Update chart based on selected range
        async function updateChart() {
            try {
                const range = document.getElementById('chartRange').value;
                const response = await fetch(`/api/saldo`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to fetch chart data');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    saldoChart.data.labels = data.chart_labels;
                    saldoChart.data.datasets[0].data = data.chart_data;
                    saldoChart.update();
                    showNotification('Chart updated successfully', 'success');
                } else {
                    throw new Error(data.message || 'Failed to update chart');
                }
            } catch (error) {
                console.error('Error updating chart:', error);
                showNotification('Failed to update chart: ' + error.message, 'error');
            }
        }

        // Refresh saldo data
        async function refreshSaldo() {
            try {
                const response = await fetch('/api/saldo');
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to fetch balance data');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    document.querySelector('.saldo-amount').textContent = 
                        'Rp ' + data.total_saldo.toLocaleString('id-ID');
                    
                    saldoChart.data.labels = data.chart_labels;
                    saldoChart.data.datasets[0].data = data.chart_data;
                    saldoChart.update();
                    
                    showNotification('Portfolio balance refreshed', 'success');
                } else {
                    throw new Error(data.message || 'Failed to refresh balance');
                }
            } catch (error) {
                console.error('Error refreshing saldo:', error);
                showNotification('Failed to refresh balance: ' + error.message, 'error');
            }
        }

        // Modal functions
        const tradeModal = document.getElementById('tradeModal');
        const saldoModal = document.getElementById('saldoModal');
        const tradeForm = document.getElementById('tradeForm');
        const modalTitleText = document.getElementById('modalTitleText');

        function openTradeModal(trade = null) {
            if (trade) {
                modalTitleText.textContent = 'Edit Trading Position';
                document.getElementById('tradeId').value = trade.id;
                document.getElementById('nama_koin').value = trade.nama_koin;
                
                // Format modal value
                const modalInput = document.getElementById('modal');
                modalInput.value = trade.modal.toLocaleString('id-ID');
                const modalHidden = modalInput.parentElement.querySelector('input[type="hidden"]');
                if (modalHidden) {
                    modalHidden.value = trade.modal.toString();
                }
                
                document.getElementById('status').value = trade.status;
                
                // Format jumlah_profit value
                const profitInput = document.getElementById('jumlah_profit');
                profitInput.value = trade.jumlah_profit.toLocaleString('id-ID');
                const profitHidden = profitInput.parentElement.querySelector('input[type="hidden"]');
                if (profitHidden) {
                    profitHidden.value = trade.jumlah_profit.toString();
                }
            } else {
                modalTitleText.textContent = 'Add Trading Position';
                tradeForm.reset();
                document.getElementById('tradeId').value = '';
                document.getElementById('status').value = '';
                
                // Clear hidden fields
                document.querySelectorAll('input[type="hidden"]').forEach(input => {
                    input.value = '';
                });
            }
            tradeModal.style.display = 'flex';
        }

        function closeModal() {
            tradeModal.style.display = 'none';
        }

        function openSaldoModal() {
            // Format initial value
            const saldoInput = document.getElementById('saldo_awal');
            const currentSaldo = {{ total_saldo - total_profit }};
            saldoInput.value = currentSaldo.toLocaleString('id-ID');
            
            const hiddenInput = saldoInput.parentElement.querySelector('input[type="hidden"]');
            if (hiddenInput) {
                hiddenInput.value = currentSaldo.toString();
            }
            
            // Update placeholder based on current value
            if (currentSaldo === 0) {
                document.querySelector('#saldoModal .modal-header h2').innerHTML = '<i class="fas fa-sliders-h"></i> Set Starting Balance';
                document.querySelector('#saldoForm button[type="submit"]').innerHTML = '<i class="fas fa-check-circle"></i> Set Balance';
            } else {
                document.querySelector('#saldoModal .modal-header h2').innerHTML = '<i class="fas fa-sliders-h"></i> Adjust Portfolio Balance';
                document.querySelector('#saldoForm button[type="submit"]').innerHTML = '<i class="fas fa-check-circle"></i> Update Balance';
            }
            
            saldoModal.style.display = 'flex';
        }

        function closeSaldoModal() {
            saldoModal.style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target === tradeModal) closeModal();
            if (event.target === saldoModal) closeSaldoModal();
        }

        // Trade Form submission - FIXED
        tradeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const tradeId = document.getElementById('tradeId').value;
            
            // Get raw numeric values
            const modalValue = getNumberValue('modal');
            const jumlahProfitValue = getNumberValue('jumlah_profit');
            
            const tradeData = {
                nama_koin: document.getElementById('nama_koin').value.toUpperCase().trim(),
                modal: modalValue,
                status: document.getElementById('status').value,
                jumlah_profit: jumlahProfitValue
            };
            
            // Validation
            if (!tradeData.nama_koin || tradeData.nama_koin === '') {
                showNotification('Asset symbol is required!', 'error');
                return;
            }
            
            if (!tradeData.modal || tradeData.modal <= 0) {
                showNotification('Capital amount must be greater than 0!', 'error');
                return;
            }
            
            if (!tradeData.status) {
                showNotification('Please select a position status!', 'error');
                return;
            }
            
            if (isNaN(tradeData.jumlah_profit)) {
                showNotification('Profit/Loss amount is required!', 'error');
                return;
            }
            
            // Show loading state
            const submitBtn = tradeForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading"></span> Processing...';
            submitBtn.disabled = true;
            
            // Determine endpoint and method
            let url, method;
            if (tradeId) {
                // Update existing trade
                url = `/api/trades/${tradeId}`;
                method = 'PUT';
            } else {
                // Add new trade
                url = '/api/trades/add';
                method = 'POST';
            }
            
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(tradeData)
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.message || `HTTP ${response.status}`);
                }
                
                closeModal();
                showNotification(
                    tradeId ? 'Position updated successfully!' : 'Position added successfully!', 
                    'success'
                );
                
                // Reload page after short delay
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Error saving trade:', error);
                showNotification('Error: ' + error.message, 'error');
            } finally {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Saldo Form submission - FIXED
        document.getElementById('saldoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get raw numeric value
            const saldoValue = getNumberValue('saldo_awal');
            
            const saldoData = {
                saldo_awal: saldoValue,
                keterangan: document.getElementById('keterangan').value
            };
            
            // Validation
            if (isNaN(saldoData.saldo_awal) || saldoData.saldo_awal < 0) {
                showNotification('Starting balance must be 0 or a positive number!', 'error');
                return;
            }
            
            // Show loading state
            const submitBtn = saldoForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading"></span> Processing...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch('/api/saldo/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saldoData)
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.message || `HTTP ${response.status}`);
                }
                
                closeSaldoModal();
                showNotification('Balance updated successfully!', 'success');
                
                // Reload page after short delay
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Error updating saldo:', error);
                showNotification('Error: ' + error.message, 'error');
            } finally {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Edit trade - FIXED (using proper selector)
        async function editTrade(id) {
            try {
                const response = await fetch(`/api/trades/${id}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `HTTP ${response.status}`);
                }
                
                const trade = await response.json();
                
                // Check if we got a proper trade object
                if (!trade || typeof trade !== 'object') {
                    throw new Error('Invalid trade data received');
                }
                
                openTradeModal(trade);
                
            } catch (error) {
                console.error('Error fetching trade:', error);
                showNotification('Failed to load position: ' + error.message, 'error');
                
                // Fallback: Try to load from table row by ID
                const row = document.getElementById(`trade-row-${id}`);
                if (row) {
                    const cells = row.querySelectorAll('td');
                    const modalText = cells[2].textContent.replace(/[^0-9.-]+/g,"");
                    const profitText = cells[4].textContent.replace(/[^0-9.-]+/g,"");
                    
                    const tradeData = {
                        id: parseInt(cells[0].textContent.replace('#', '')),
                        nama_koin: cells[1].querySelector('span').textContent.trim(),
                        modal: parseFloat(modalText) || 0,
                        status: cells[3].querySelector('.status-badge').classList.contains('status-profit') ? 'profit' : 'loss',
                        jumlah_profit: parseFloat(profitText) || 0
                    };
                    openTradeModal(tradeData);
                    showNotification('Using local data...', 'info');
                }
            }
        }

        // Delete trade - FIXED (using row ID selector)
        async function deleteTrade(id, button) {
            if (!confirm('Are you sure you want to delete this trading position?\nThis action cannot be undone.')) {
                return;
            }
            
            // Show loading state
            const deleteBtn = button;
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<span class="loading"></span> Deleting...';
            deleteBtn.disabled = true;
            
            try {
                const response = await fetch(`/api/trades/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.message || `HTTP ${response.status}`);
                }
                
                showNotification('Position deleted successfully', 'success');
                
                // Remove the row from table immediately using row ID
                const row = document.getElementById(`trade-row-${id}`);
                if (row) {
                    row.style.opacity = '0.5';
                    row.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        row.remove();
                        // Check if table is now empty
                        if (document.querySelectorAll('#tradeTable tr').length === 0) {
                            location.reload(); // Reload to show empty state
                        }
                    }, 300);
                }
                
            } catch (error) {
                console.error('Error deleting trade:', error);
                showNotification('Error: ' + error.message, 'error');
            } finally {
                // Restore button state
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            }
        }

        // Search functionality with debounce
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('keyup', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = this.value.toLowerCase().trim();
                const rows = document.querySelectorAll('#tradeTable tr');
                
                let visibleCount = 0;
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (searchTerm === '' || text.includes(searchTerm)) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // Show notification if no results found
                if (searchTerm !== '' && visibleCount === 0) {
                    showNotification('No positions found matching "' + searchTerm + '"', 'warning');
                }
            }, 300);
        });

        // Notification function
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            document.querySelectorAll('.notification').forEach(el => el.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            // Set icons based on type
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'error') icon = '‚ùå';
            if (type === 'warning') icon = '‚ö†Ô∏è';
            if (type === 'info') icon = 'üí°';
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 18px;">${icon}</span>
                    <span style="flex: 1;">${message}</span>
                </div>
                <button onclick="this.parentElement.remove()" style="
                    background: none; 
                    border: none; 
                    color: var(--dark-gray); 
                    cursor: pointer; 
                    font-size: 20px;
                    opacity: 0.6;
                    transition: opacity 0.3s;
                    padding: 0 5px;
                    line-height: 1;
                " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
                    √ó
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            
            // Add CSS for number inputs
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
                
                /* Add subtle animation to stat cards */
                @keyframes fadeInUp {
                    from {
                        opacity: 0;
                        transform: translateY(20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                
                .stat-card {
                    animation: fadeInUp 0.6s ease forwards;
                }
                
                .stat-card:nth-child(1) { animation-delay: 0.1s; }
                .stat-card:nth-child(2) { animation-delay: 0.2s; }
                .stat-card:nth-child(3) { animation-delay: 0.3s; }
                .stat-card:nth-child(4) { animation-delay: 0.4s; }
                
                /* Number input styling */
                .number-input {
                    font-family: 'Inter', monospace;
                    letter-spacing: 0.5px;
                }
                
                .number-input:focus {
                    border-color: var(--primary) !important;
                    background-color: var(--primary-pastel) !important;
                }
                
                /* Loading spinner */
                .loading {
                    display: inline-block;
                    width: 16px;
                    height: 16px;
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    border-top: 2px solid white;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin-right: 8px;
                    vertical-align: middle;
                }
                
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                /* Button disabled state */
                button:disabled {
                    opacity: 0.6;
                    cursor: not-allowed !important;
                }
                
                /* Hover effects for table rows */
                tbody tr {
                    transition: all 0.2s ease;
                }
                
                tbody tr:hover {
                    transform: translateX(4px);
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                }
                
                /* Input validation styles */
                input:invalid {
                    border-color: var(--danger) !important;
                }
                
                input:valid {
                    border-color: var(--success) !important;
                }
                
                /* Empty state styling */
                .empty-state {
                    text-align: center;
                    padding: 60px 20px;
                }
                
                .empty-state-icon {
                    font-size: 64px;
                    color: var(--gray);
                    margin-bottom: 20px;
                }
            `;
            document.head.appendChild(style);
            
            // Initialize tooltips
            document.querySelectorAll('.tooltip').forEach(element => {
                element.addEventListener('mouseenter', function(e) {
                    const tooltip = this.querySelector('.tooltip-text');
                    if (tooltip) {
                        tooltip.style.visibility = 'visible';
                        tooltip.style.opacity = '1';
                    }
                });
                
                element.addEventListener('mouseleave', function(e) {
                    const tooltip = this.querySelector('.tooltip-text');
                    if (tooltip) {
                        tooltip.style.visibility = 'hidden';
                        tooltip.style.opacity = '0';
                    }
                });
            });
            
            // Initialize number inputs
            document.querySelectorAll('.number-input').forEach(input => {
                // Format on blur
                input.addEventListener('blur', function() {
                    formatNumberInput(this);
                });
                
                // Allow only numbers and minus sign
                input.addEventListener('keypress', function(e) {
                    const char = String.fromCharCode(e.keyCode || e.which);
                    if (!/[\d-]/.test(char) && e.keyCode !== 8 && e.keyCode !== 46) {
                        e.preventDefault();
                    }
                });
            });
        });
    </script>
</body>
</html>